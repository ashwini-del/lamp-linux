---
#httpd installation
- name: "Webserver Package Installation for linux"
  yum:
    name: httpd
    state: present
  notify:
    - Restarting-enabling-httpd
#php installation
- name: "PHP Package Installation"
  shell: amazon-linux-extras install php7.4 -y
- name: "Create httpd conf template"
  template:
   src: httpd.conf.tmpl
   dest: /etc/httpd/conf/httpd.conf
  notify:
   - Restarting-enabling-httpd
#add vhost template
- name: "Create vhost from template"
  template:
   src: vhost.conf.tmpl
   dest: "/etc/httpd/conf.d/{{ domain_name }}.conf"
  notify:
   - Restarting-enabling-httpd
# create Document root
- name: "Create documentroot"
  file:
   path: "{{ doc_root }}/{{ domain_name }}/"
   state: directory
   owner: "{{ httpd_user }}"
   group: "{{ httpd_group }}"
#add default page of php
- name: "Create test.php and test.html"
  copy:
    src: "{{ item }}"
    dest: "{{ doc_root }}/{{ domain_name }}/"
    owner: "{{ httpd_user }}"
    group: "{{ httpd_group }}"
  with_items:
    - test.php
    - test.html
#Installing the database
# install all prereqisites
- name: Install LAMP Packages
  yum: name={{ item }} update_cache=yes state=present
  loop: [ 'mysql-server', 'python3-pymysql', 'php-mysql']
  notify:
      - Restart mysql
#start and enable mysql service
- name: start and enable mysql service
  service:
    name: mysql
    state: started
    enabled: yes
#creating mysql user and database
- name: creating mysql user
  mysql_user:
    name: "{{db_user}}"
    password: "{{db_pass}}"
    priv: '*.*:ALL,GRANT'
    host: localhost
    state: present
- name: creating database
  mysql_db:
    name: "{{db_name}}"
    state: present
#enable root login to user
- name: Enable remote login to mysql
  lineinfile:
      path: /etc/mysql/mysql.conf.d/mysqld.cnf
      regexp: '^bind-address'
      line: 'bind-address = 0.0.0.0'
      backup: yes
  notify:
      - Restart mysql
- name: Sets the root password
  mysql_user:
    name: root
    password: "{{ db_pass }}"
    login_unix_socket: /var/run/mysqld/mysqld.sock
